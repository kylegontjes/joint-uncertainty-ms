---
title: "Construct parent child dataset with transition statistics of all reconstructions"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```
 
# Load data
```{r}  
phy <- ape::read.tree("./data/empirical/tree/tree.treefile")
dat <- readRDS("./data/empirical/dataset/df.RDS")
dat <- dat[match(phy$tip.label, dat[['isolate_no']]), ]
```

```{r}
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
genotypes <-  genotypes %>% .[match(phy$tip.label,.[['isolate_no']]),]

df <- left_join(dat,genotypes)
```

# Reconsctructions
```{r}
focals <- readRDS("~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/data/empirical/joint_reconstruction/phenotype_genotype_focal_asrs.RDS")
joint_uncs <- readRDS("~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/data/empirical/joint_reconstruction/phenotype_genotype_joint_uncertainty_asrs.RDS")
dbres <- readRDS("./data/empirical/joint_reconstruction/joint_uncertainty_asr_clustering_optimal.RDS")
```

# Generate pcdfs 

```{r} 
get_parent_child_df_from_states <- function(states,dat,tr,feature){ 
  # Outcome string
  outcome_str <- dat[,feature] %>% `names<-`(dat[['isolate_no']])
  
  # Get Parent Child data
  parent_child_df <- get_parent_child_data(tr=tr, ancestral_states=states, trait_data  =outcome_str, confidence_threshold  = NULL, node_states='joint')

  # Annotate parent child data
  parent_child_df <- get_continuation_data(parent_child_df,'joint')
  return(parent_child_df)
}

names_of_uncs <- names(joint_uncs)

states <- pbmcapply::pbmclapply(names_of_uncs,FUN=function(name,focal,joint_uncs){
  # get states
  focal_states = focals[[name]]$states
  # get states from joint_uncs
  joint_unc_states = lapply(joint_uncs[[name]]$sampled_joints,FUN=function(x){x[["anc.states"]]}) 
  names(joint_unc_states) = paste0("alt_recon_", seq_len(length(paste0("alt_recon_", seq_len(length(joint_unc_states))))))
  
  joint_unc_states[['focal_states']] = focal_states
   
  return(joint_unc_states)
},mc.cores =7,focal = focals,joint_uncs = joint_uncs)  %>% `names<-`(names_of_uncs)

parent_child_dfs <- lapply(names_of_uncs,FUN=function(name,dat,tr,states){
  pcdfs <- pbmcapply::pbmclapply(states[[name]] ,get_parent_child_df_from_states,dat=dat,tr = tr,feature = name,mc.cores =7)
  names(pcdfs) <- names(states[[name]])
  return(pcdfs)
},dat=df,tr = phy, states = states) %>% `names<-`(names_of_uncs)
```

```{r}
saveRDS(parent_child_dfs,"./data/empirical/phyloAMR/joint_states_parent_child_dfs.RDS")
```

# ASR transition data 
```{r} 
# Generate transition statistics
state_transition_statistics <- lapply(names_of_uncs,FUN=function(name){
  reconstructions <- parent_child_dfs[[name]]
  pbmcapply::pbmclapply(reconstructions,asr_transition_analysis,node_states='joint',mc.cores = 7)  %>% do.call(rbind,.) %>% mutate(reconstruction = rownames(.),trait = name) 
})  %>% `names<-`(names_of_uncs)

saveRDS(state_transition_statistics,"./data/empirical/phyloAMR/joint_states_reconstruction_transition_statistics.RDS")
```

# Extract representative from blbli clusters
```{r}
# Extract best reconstruction per cluster
extract_best_per_cluster <- function(cluster,cluster_str,joint_ci,state_df){
  cluster_id = which(cluster_str == cluster)
  cluster_logs <- joint_ci$lnliks[cluster_id]
  lowest_log_val <- which.max(cluster_logs)
  lowest_val_id = cluster_id[lowest_log_val]
  cluster_states <- state_df[lowest_val_id,]  %>% unlist %>% `names<-`(NULL)
  return(lowest_val_id)
}
n_clusters = length(unique(dbres$cluster) %>% subset(.!=0))
clusters = seq_len(n_clusters)
clusters_str = dbres$cluster
state_df_matrix <- as.matrix(joint_uncs$blbli_dich_num$state_df)
cluster_joint_states <- lapply(clusters,extract_best_per_cluster,clusters_str,joint_uncs$blbli_dich_num,state_df_matrix) %>% unlist  %>% `names<-`(seq_along(.))
cluster_representatives_state_parent_childs <- lapply(cluster_joint_states,FUN=function(x){
  parent_child_dfs$blbli_dich_num[[paste0("alt_recon_",x)]]
})   %>% `names<-`(paste0("JR_cluster_",seq_len(length(.))))
   
# Best joint
best_joint_parent_child<- parent_child_dfs$blbli_dich_num$focal_states
 
best_parent_child_states <-  c(list(parent_child_dfs$blbli_dich_num$focal_states), cluster_representatives_state_parent_childs) %>% `names<-`(c("best_joint",paste0("JR_cluster_",seq_len(length(cluster_representatives_state_parent_childs)))))

saveRDS(best_parent_child_states,'./data/empirical/phyloAMR/representative_blbli_joint_uncertainty_parent_child_dfs.RDS')
```