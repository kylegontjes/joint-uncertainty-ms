---
title: "phyloAMR generate and analyze reconstruction clustering calls"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Dataset
```{r} 
dat <- readRDS("./data/empirical/dataset/df.RDS")
phy <- read.tree("./data/empirical/tree/tree.treefile")  
```

## Joint unc data
```{r} 
parent_child_dfs <- readRDS("./data/empirical/phyloAMR/joint_states_parent_child_dfs.RDS")
```

# Perform clustering analysis
```{r} 
clustering <- lapply(names(parent_child_dfs),FUN=function(x){ 
  trait_pcdfs <- parent_child_dfs[[x]]
  
  pbmcapply::pbmclapply(trait_pcdfs,FUN=function(pcdf){
    asr_cluster_detection(df = dat,tr = phy,tip_name_variable  = 'isolate_no',patient_id = 'Patient_ID',parent_child_df = pcdf,node_states = 'joint',confidence = NULL,simplify_faux_clusters = T,simplify_revertant = T,collapse_cluster = T)
  },mc.cores = 7) %>% `names<-`(names(trait_pcdfs))
}) %>% `names<-`(names(parent_child_dfs))

saveRDS(clustering,"./data/empirical/phyloAMR/phenotype_genotype_joint_uncertainty_asr_clustering.RDS")
```

# Clustering statistics
```{r} 
cluster_analysis <- lapply(names(clustering),FUN=function(x){ 
  clustering_pcdfs <- clustering[[x]]
   pbmcapply::pbmclapply(clustering_pcdfs,FUN=function(pcdf){
     asr_cluster_analysis(pcdf)
   }) %>% do.call(rbind.data.frame,.) %>% mutate(reconstruction_axis = names(clustering_pcdfs),trait = x)
})%>% `names<-`(names(clustering))

cluster_analysis_df <- do.call(rbind.data.frame,cluster_analysis) 

saveRDS(cluster_analysis_df,"./data/empirical/phyloAMR/phenotype_genotype_joint_uncertainty_asr_clustering_statistics.RDS")
```
 