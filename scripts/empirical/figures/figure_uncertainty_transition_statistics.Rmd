---
title: "Supplemental Figure - Transition and clustering statistics"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

# Environment
```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Dataset
```{r} 
dat <- readRDS("./data/empirical/dataset/df.RDS") 
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
```

# Transition data
```{r} 
# Transition statistics
state_transition_statistics <- readRDS("./data/empirical/phyloAMR/joint_states_reconstruction_transition_statistics.RDS")  %>% .[["blbli_dich_num"]] 

# Clustering
clustering <- readRDS("./data/empirical/joint_reconstruction/hclust_consensus_distance_matrix_six_clusters_string.RDS") 
cluster_statistics <- readRDS("./data/empirical/phyloAMR/phenotype_genotype_joint_uncertainty_asr_clustering_statistics.RDS") %>% subset(trait=='blbli_dich_num')  
cluster_statistics$cluster_size_max <- str_split(cluster_statistics$cluster_size_range,"-",simplify=T) %>% .[,2] %>% as.numeric() 
 
# Join clustering and transition states
recon_stats <- left_join(state_transition_statistics,cluster_statistics)
```

# Figure
## Curate data
```{r}
# Curate best
best_joint_parent_child_transitions <- recon_stats[recon_stats$reconstruction == 'focal_states',] 
best_joint_parent_child_transitions_simple <- best_joint_parent_child_transitions %>% select(transitions,gains,gains_tip,losses,losses_tip,continuations_present,continuations_absent,singletons,singleton_isolates,clusters,cluster_isolates,cluster_size_median,cluster_size_max,revertant_isolates)
   
colnames(best_joint_parent_child_transitions_simple) <- c("Transitions","Gain Events","Gain Events (Tips)","Loss Events","Loss Events (Tips)","Continuations (Present)","Continuations (Absent)","Resistant singletons","Singleton isolates","Resistant clusters","Cluster isolates","Cluster size (median)","Cluster size (max)","Revertant isolates")

# Curate state transition data
alt_recons <-  recon_stats[recon_stats$reconstruction != 'focal_states',] 
alt_recons$cluster <- clustering %>% as.numeric()
transition_data_simple <- alt_recons %>% select(transitions,gains,gains_tip,losses,losses_tip,continuations_present,continuations_absent,singletons,singleton_isolates,clusters,cluster_isolates,cluster_size_median,cluster_size_max,revertant_isolates,cluster)
colnames(transition_data_simple) <- c("Transitions","Gain Events","Gain Events (Tips)","Loss Events","Loss Events (Tips)","Continuations (Present)","Continuations (Absent)","Resistant singletons","Singleton isolates","Resistant clusters","Cluster isolates","Cluster size (median)","Cluster size (max)","Revertant isolates","Cluster")
```

## Create figures
```{r,fig.width=10.5,fig.height=8.4}
transitional_data <- lapply(colnames(transition_data_simple),FUN=function(x){
  # Number of bins
  num_bins = length(unique(transition_data_simple[[x]])) 
  
  # Extract value from best joint transition data
  value_from_best <- best_joint_parent_child_transitions_simple[[x]]
  
  # GGplot figure
  figure <- ggplot(data=transition_data_simple,aes(x=get(x),fill=as.factor(Cluster))) + geom_histogram(bins=num_bins) + xlab(x)  + ylab('Count')+ theme_bw() + phylogenetic_reconstruction_numeric_scale  + theme(legend.position = 'none', axis.text =   element_text(size=12, color="black"), axis.title = element_text(size = 14, color="black"))  + geom_vline(xintercept = value_from_best,linetype = 2,color = 'black') 
  
  if(x == "Cluster"){
    figure + scale_x_continuous(breaks = c(1:max(transition_data_simple$Cluster)))
  } else {
    figure
  }
  
}) %>% cowplot::plot_grid(plotlist = .,labels = "AUTO",label_size = 16)

transitional_data
```

# Save cowplot
```{r, save figure}
ggsave("./figures/empirical/phyloAMR_alternative_reconstruction_transition_statistics.png", dpi = 900, bg = 'white', plot = transitional_data, width=10.5, height=8.4)
```
