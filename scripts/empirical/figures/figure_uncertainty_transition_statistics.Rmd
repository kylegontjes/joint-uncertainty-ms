---
title: "Figure X - transition statistics"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Dataset
```{r} 
dat <- readRDS("./data/empirical/dataset/df.RDS")
phy <- read.tree("./data/empirical/tree/tree.treefile") 
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
```

# Transition data
```{r} 
state_transition_statistics <- readRDS("./data/empirical/phyloAMR/joint_states_reconstruction_transition_statistics.RDS")  %>% .[["blbli_dich_num"]]
dbres <- readRDS("./data/empirical/joint_reconstruction/joint_uncertainty_asr_clustering_optimal.RDS")
```

# Figure
```{r}
# Curate best
best_joint_parent_child_transitions <- state_transition_statistics %>% subset(reconstruction == 'focal_states')
best_joint_parent_child_transitions_simple <- best_joint_parent_child_transitions %>% select(-gain_frequency,-loss_frequency,-continuation_present_frequency,-continuations,,-continuation_absent_frequency,-total_edges)
colnames(best_joint_parent_child_transitions_simple) <- c("Transitions","Gain Events","Gain Events (Tips)","Loss Events","Loss Events (Tips)","Continuations (Present)","Continuations (Absent)")

# Curate state transition data
alt_recons <- state_transition_statistics %>% subset(reconstruction!='focal_states')
alt_recons$cluster <- dbres$cluster %>% as.numeric()
transition_data_simple <- alt_recons %>% select(-reconstruction,-gain_frequency,-loss_frequency,-continuation_present_frequency,-continuations,-trait,-continuation_absent_frequency,-total_edges)
colnames(transition_data_simple) <- c("Transitions","Gain Events","Gain Events (Tips)","Loss Events","Loss Events (Tips)","Continuations (Present)","Continuations (Absent)","Cluster")

```

```{r}
transitional_data <- lapply(colnames(transition_data_simple),FUN=function(x){
  num_bins = length(unique(transition_data_simple[[x]]))
  value_from_best <- best_joint_parent_child_transitions_simple[[x]]
  
  ggplot(data=transition_data_simple,aes(x=get(x),fill=as.factor(Cluster))) + geom_histogram(bins=num_bins) + xlab(x)  + ylab('Count')+ theme_bw() + tnsecluster_scale_fill  + theme(legend.position = 'none')  + geom_vline(xintercept = value_from_best,linetype = 2,color = 'black') 
  
}) %>% cowplot::plot_grid(plotlist = .,labels = "AUTO")

transitional_data

ggsave("./figures/empirical/phyloAMR_alternative_reconstructoin_transitions_statistics.png",dpi = 900,bg = 'white',plot = transitional_data,width=15,height=12.5)
```

