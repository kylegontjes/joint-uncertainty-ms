---
title: "Figure phylogeny with resistance and genotypes"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

# Environment
```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR','ggtree') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Dataset
```{r} 
dat <- readRDS("./data/empirical/dataset/df.RDS")
phy <- read.tree("./data/empirical/tree/tree.treefile") 
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") %>% select(isolate_no,"AA552","OmpK36_c25t","OmpK36GD","OmpK36TD","OmpK36_promoter_IS","OmpK36_disruptive","PBP_any","RamR","RamA")
```

```{r} 
phyloAMR_cluster_df <- readRDS("./data/empirical/phyloAMR/representative_blbli_joint_uncertainty_asr_clustering_df.RDS")
cluster_stats <- readRDS("./data/empirical/phyloAMR/representative_blbli_joint_uncertainty_asr_clustering_statistics.RDS")
dat <- left_join(dat,phyloAMR_cluster_df)
rownames(dat) <- dat$isolate_no
```

## Phylogenetic tree 
```{r, tree with states} 
number_clusters <- nrow(cluster_stats)-1
p0 <- gheatmap(ggtree(phy),dat %>% select(blbli_dich_num) %>% mutate_all(as.factor) %>% `colnames<-`("BL/BLI resistance"),color=NULL,width=0.1,colnames_position = "top",colnames_angle = 90,colnames_offset_y = 0.05, hjust = 0,font.size = 3.15) + Resistance_scale
p0.1 <- p0 + ggnewscale::new_scale_fill()

JR_variables <- cluster_stats$phenotype_axis %>% subset(.!='best_joint')
p1 <-  gheatmap(p0.1,dat %>% select(best_joint_asr_cluster_renamed) %>% `colnames<-`("Best joint reconstruction"),offset =0.000025,width=0.1,color=NULL,colnames_position = "top",colnames_angle = 90,colnames_offset_y = 0.05, hjust = 0,font.size = 3.25) + cluster_scale  + ylim(NA,635)

p1.1 <- gheatmap(p1,dat %>% select(any_of(paste0(JR_variables,"_asr_cluster_renamed"))) %>% `colnames<-`(paste0("Reconstruction axis ",1:number_clusters)),offset =0.00005,width=0.1*number_clusters,color=NULL,colnames_position = "top",colnames_angle = 90,colnames_offset_y = 0.05, hjust = 0,font.size = 3.15) + cluster_scale  + ylim(NA,625)
```

```{r, fig.height=8.4375,fig.width=6.75}
p1.2 <- p1.1 + ggnewscale::new_scale_fill()
colnames(genotypes) <-  recode_genotypes(colnames(genotypes)) %>% collapse_PFAV(.)

clustered_heatmap <- ComplexHeatmap::Heatmap(genotypes %>% select(-isolate_no) %>% mutate_all(as.numeric))
column_order_ <- colnames(genotypes %>% select(-isolate_no))[ComplexHeatmap::column_order(clustered_heatmap)]

rownames(genotypes) <- genotypes$isolate_no

p2 <- gheatmap(p1.2,genotypes %>% select(column_order_) %>% mutate_all(as.factor),offset=(0.000235),width=0.1*ncol(genotypes %>% select(-isolate_no)),color=NULL,colnames_position = "top",colnames_angle = 90,colnames_offset_y = 0.1, hjust = 0,font.size=3.05)  + factor_scale + ylim(NA,580) +  theme(legend.position = 'bottom',legend.direction="horizontal", legend.justification = "center", legend.key = element_rect(colour = c('black')),
    legend.spacing.x = unit(0.025, "cm"),legend.key.size = unit(0.5,"cm"))

p2_wo_legend <- p2 + theme(legend.position = 'none') + theme(plot.margin = margin(t=0,r=0,b=-0.8,l=-0.5,unit='cm'))

p2_wo_legend
p2_legend <- cowplot::get_legend(p2)

figure <- cowplot::plot_grid(p2_wo_legend,p2_legend,ncol=1,rel_heights = c(1,0.1))
figure
```

```{r, save}
ggsave("./figures/empirical/phylogeny_with_resistance_genotypes.png", dpi = 900, bg = 'white', plot = figure, width=6.75, height=8.4375)
```
