---
title: "Pairwise comparisons as boxplot"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','proxy','dbscan','Rtsne','phyloAMR','kableExtra') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```
 
# Load data
```{r}  
phy <- ape::read.tree("./data/empirical/tree/tree.treefile")
dat <- readRDS("./data/empirical/dataset/df.RDS")
dat <- dat[match(phy$tip.label, dat[['isolate_no']]), ]
```

```{r}
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
genotypes <-  genotypes %>% .[match(phy$tip.label,.[['isolate_no']]),]

df <- left_join(dat,genotypes)
```

# Reconsctructions
```{r}
focals <- readRDS("./data/empirical/joint_reconstruction/phenotype_genotype_focal_asrs.RDS")
joint_uncs <- readRDS("./data/empirical/joint_reconstruction/phenotype_genotype_joint_uncertainty_asrs.RDS")
```

# Pairwise phyloAMR data
```{r}
pairwise_comparisons <- readRDS("./data/empirical/phyloAMR/pairwise_synchronous_transitions_comparisons.RDS") %>% subset(genotype_reconstruction != 'focal_states')
```

## Recode genotypes
```{r}
pairwise_comparisons$genotype <- factor(
pairwise_comparisons$genotype,levels = rev(c("AA018","AA552","OmpK36_c25t","OmpK36GD","OmpK36TD","OmpK36_promoter_IS","OmpK36_truncation_kleborate","OmpK36_putative_function_altering","PBP2","PBP4","AcrAB_TolC_any","RamR","RamA")))

pairwise_comparisons$genotype <- recode(pairwise_comparisons$genotype ,'OmpK35-25'='ompK35 porin truncation at 25%','OmpK36_c25t'='25 cytosine-to-thymine transition in ompK36','OmpK36_L3_mutations'='Loop 3 insertion in ompK36','OmpK36GD'='GD loop 3 insertion','OmpK36TD'='TD loop 3 insertion','OmpK36_truncation_kleborate'='ompK36 truncation', 'OmpK36_non_syn'='ompK36 non-synonymous mutation','OmpK36_putative_function_altering'='ompK36 PFAV','OmpK36_intergenic'='Mutation in intergenic region of ompK36','OmpK36_promoter_IS'='Insertion seqeunce at ompK36 promoter',"AcrAB_TolC_any" = 'acrAB-tolC efflux pump mutant','RamR'='ramR efflux pump regulator PFAV',"RamA"='ramA efflux pump activator PFAV','PBP_any'='Non-synonymous mutations in penicillin-binding-proteins','PBP2'='Penicillin-binding protein-2 mutant',"PBP4"='Penicillin-binding protein-4 mutant',"AA018" = "AA018 blaKPC-containing plasmid","AA552" = "AA551 blaKPC-containing plasmid") 

pairwise_comparisons$pheno_cluster <- recode(pairwise_comparisons$pheno_cluster,"focal_states" ="Best joint model",
                                             "1" ="Alternative axes 1",
                                             "2" ="Alternative axes 2",
                                             "3" ="Alternative axes 3",
                                             "4" ="Alternative axes 4",
                                             "5" ="Alternative axes 5") 
```


# Overall summary figures 

## Concordant synchronous transitions
```{r,fig.width=9,fig.height=9}
A <- ggplot(pairwise_comparisons,
       aes(x = num_concordant_transitions,
           y = as.factor(genotype),
           fill = as.factor(pheno_cluster))) +
geom_boxplot(position = position_dodge(width = 0.8)) +
labs(x = "No. concordant transitions",
     y = "",
     fill = "Phenotype axes") +
scale_fill_brewer(palette = "Set1") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme_bw()

A
```

## Discordant synchronous transitions
```{r,fig.width=9,fig.height=7.5}
B <- ggplot(pairwise_comparisons,
       aes(x = num_discordant_transitions,
           y = as.factor(genotype),
           fill = as.factor(pheno_cluster))) +
geom_boxplot(position = position_dodge(width = 0.8)) +
labs(x = "No. discordant transitions",
     y = "",
     fill = "Pheno Cluster") +
scale_fill_brewer(palette = "Set1") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme_bw()

B
```

# Differences
```{r}
pairwise_comparisons$difference_transition_type <- pairwise_comparisons$num_concordant_transitions - pairwise_comparisons$num_discordant_transitions
C <- ggplot(pairwise_comparisons,
       aes(x = difference_transition_type,
           y = as.factor(genotype),
           fill = as.factor(pheno_cluster)))  +
geom_boxplot(position = position_dodge(width = 0.8)) +
labs(x = "Difference in transition type",
     y = "",
     fill = "Pheno Cluster") +
scale_fill_brewer(palette = "Set1") +
theme(axis.text.x = element_text(angle = 45, hjust = 1)) + theme_bw() + geom_vline(xintercept = 0,colour = "red",linetype = 2)

C
```
# Merged
```{r,fig.width=13 ,fig.height=13}
AB <- cowplot::plot_grid(A + theme(legend.position = 'none'),B + theme(legend.position = 'none'),ncol=2,labels="AUTO")
legend_fig <- cowplot::get_legend(A)  %>% cowplot::plot_grid()

C_legend <- cowplot::plot_grid(C + theme(legend.position = 'none'),legend_fig,ncol=2,labels=c("C",""))
  
figure <- cowplot::plot_grid(AB,C_legend,ncol=1,rel_widths = c(1,1))

figure

ggsave("./figures/empirical/pairwise_reconstruction_synchronous_transition_comparisons_boxplot.png",dpi = 900,bg = 'white',plot = AB,width=13,height=12)
```

