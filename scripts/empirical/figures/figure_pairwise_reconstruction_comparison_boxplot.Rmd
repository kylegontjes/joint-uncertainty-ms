---
title: "Pairwise comparisons as boxplot"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

# Environment
```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','proxy','dbscan','Rtsne','phyloAMR','kableExtra','ggtext','forcats') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```
 
# Load data
## Phylogeny
```{r, phylogeny}  
phy <- ape::read.tree("./data/empirical/tree/tree.treefile")
dat <- readRDS("./data/empirical/dataset/df.RDS")
dat <- dat[match(phy$tip.label, dat[['isolate_no']]), ]
clustering_str <- readRDS("./data/empirical/joint_reconstruction/hclust_consensus_distance_matrix_seven_clusters_string.RDS")
```

```{r, genotypes}
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
genotypes <-  genotypes %>% .[match(phy$tip.label,.[['isolate_no']]),]

df <- left_join(dat,genotypes)
```

# Reconsctructions
```{r, reconstructions}
focals <- readRDS("./data/empirical/joint_reconstruction/phenotype_genotype_focal_asrs.RDS")
joint_uncs <- readRDS("./data/empirical/joint_reconstruction/phenotype_genotype_joint_uncertainty_asrs.RDS")
parent_child_dfs <- readRDS("./data/empirical/phyloAMR/joint_states_parent_child_dfs.RDS")
```

# Pairwise phyloAMR data
```{r, phyloAMR data}
pairwise_comparisons <- readRDS("./data/empirical/phyloAMR/pairwise_synchronous_transitions_genotype_as_comparitor.RDS") %>% subset(!genotype %in% c("AA018","AcrAB_TolC_any","OmpK36_L3_mutations","PBP2","PBP4","OmpK36_truncation_kleborate","OmpK36_putative_function_altering"))
pairwise_comps_sync_all_geno <- readRDS("./data/empirical/phyloAMR/pairwise_synchronous_transitions_phenotype_as_comparitor.RDS") %>% subset(!genotype %in% c("AA018","AcrAB_TolC_any","OmpK36_L3_mutations","PBP2","PBP4","OmpK36_truncation_kleborate","OmpK36_putative_function_altering"))
```

## Recode genotypes
## Comparison pheno
```{r, overall data curation}
overall_row <- cbind.data.frame(pheno_cluster = NA, genotype="Overall")
pairwise_comparisons <- bind_rows(pairwise_comparisons,overall_row)
pairwise_comparisons$genotype <- factor_genotypes_boxplot(pairwise_comparisons$genotype) 
pairwise_comparisons$genotype <-  recode_genotypes(pairwise_comparisons$genotype) 
levels(pairwise_comparisons$genotype) <- recode_genotypes_for_html(levels(pairwise_comparisons$genotype))  
pairwise_comparisons$pheno_cluster <- recode_phenotype_clusters(pairwise_comparisons$pheno_cluster)
```

## Comparison genotype
```{r, genotype as comparison curation}
pairwise_comps_sync_all_geno <- bind_rows(pairwise_comps_sync_all_geno,overall_row)
pairwise_comps_sync_all_geno$genotype <- factor_genotypes_boxplot(pairwise_comps_sync_all_geno$genotype)  
pairwise_comps_sync_all_geno$genotype <-  recode_genotypes(pairwise_comps_sync_all_geno$genotype)
levels(pairwise_comps_sync_all_geno$genotype) <- recode_genotypes_for_html(levels(pairwise_comps_sync_all_geno$genotype))   
pairwise_comps_sync_all_geno$pheno_cluster <- recode_phenotype_clusters(pairwise_comps_sync_all_geno$pheno_cluster)
``` 

# Overall summary figures 
## A. Concordant synchronous transitions
```{r,Figure A, fig.width=9,fig.height=9}
min_value <- min(pairwise_comparisons$synchronous_gains_num,na.rm = T)
max_value <- max(pairwise_comparisons$synchronous_gains_num,na.rm = T)

factor_order <- c("Best joint reconstruction",paste0("Reconstruction axis ",1:7))

pairwise_comparisons$pheno_cluster <- factor(
pairwise_comparisons$pheno_cluster,levels = rev(factor_order))

A <- ggplot(pairwise_comparisons,
       aes(x = synchronous_gains_num,
           y = fct_rev(genotype),
           fill = pheno_cluster)) +
geom_boxplot(position = position_dodge(width = 0.8),outlier.size = 0.9) +
labs(x = "Synchronous phenotype-genotype gain events",
     y = "",
     fill = "Reconstruction axis") + phylogenetic_reconstruction_scale + theme_bw() + scale_x_continuous(breaks = c(0,1:max_value),labels =c(0,1:max_value) )   + theme(legend.position = 'bottom',axis.text.x = element_markdown(hjust = 0.5,size=11), axis.text.y = element_markdown())

A
```
 
# Get proportion of genotypes with gain event of phenotype
```{r,Figure B, fig.width=9,fig.height=7.5} 
pairwise_comps_sync_all_geno$pheno_cluster <- factor(
pairwise_comps_sync_all_geno$pheno_cluster,levels = rev(factor_order))

B <- ggplot(pairwise_comps_sync_all_geno,
       aes(x = synchronous_gains_prop,
           y = fct_rev(genotype),
           fill = as.factor(pheno_cluster))) +
geom_boxplot(position = position_dodge(width = 0.8),outlier.size = 0.9) +
labs(x = "Proportion of genotype gains with a phenotype gain",
     y = "",
     fill = "Reconstruction axis") + phylogenetic_reconstruction_scale  + theme_bw() + theme(legend.position = 'bottom',axis.text.x = element_markdown(hjust = 0.5,size=11), axis.text.y = element_markdown())

B
```

# Proportion of phenotype gains with >=1 genotype gain
```{r,Figure C, fig.width=9,fig.height=7.5} 
pheno_recons <- pairwise_comparisons$phenotype_reconstruction %>% unique %>% sort()
genotypes <-  names(parent_child_dfs) %>% subset(.!='blbli_dich_num') %>% sort %>% subset(. %in% c("AA552","OmpK36_c25t","OmpK36GD","OmpK36TD","OmpK36_promoter_IS","OmpK36_disruptive","PBP_any","RamR","RamA"))

pheno_gain_explanation <- pbmcapply::pbmclapply(pheno_recons,FUN=function(x){
  pheno_recon_pcdf <- parent_child_dfs$blbli_dich_num[[x]]
  pheno_recon_gains <- pheno_recon_pcdf[pheno_recon_pcdf$gain==1,'child']
  pheno_recon_gains <- sort(as.numeric(pheno_recon_gains)) 
  num_pheno_gain <- length(pheno_recon_gains)
  genotype_pheno_data <- lapply(genotypes,FUN=function(geno){
    geno_recon_pcdfs <- parent_child_dfs[[geno]]
    geno_recon_gains <- lapply(geno_recon_pcdfs,FUN=function(genopcdf){
       genopcdf[genopcdf$gain==1,'child']
    }) 
    geno_recon_gains <- sort(unique(unlist(geno_recon_gains))) 
    num_nodes_w_geno_gains <- length(geno_recon_gains)
    pheno_gain_nodes_w_geno_gains <- subset(pheno_recon_gains, pheno_recon_gains  %in% geno_recon_gains)
    num_pheno_gain_nodes_w_geno_gains <- length(pheno_gain_nodes_w_geno_gains)
    prop_pheno_gains_w_geno_gain <- num_pheno_gain_nodes_w_geno_gains /     num_pheno_gain
    perc_pheno_gains_w_geno_gain <- prop_pheno_gains_w_geno_gain*100
    data.frame(genotype = geno,pheno_reconstruction = x,pheno_recon_gains = paste0(pheno_recon_gains,collapse = ','),num_pheno_gain,geno_recon_gains = paste0(geno_recon_gains,collapse=','),num_nodes_w_geno_gains,prop_pheno_gains_w_geno_gain,perc_pheno_gains_w_geno_gain)
  }) %>% do.call(rbind,.)
},mc.cores = 7)

pheno_gain_explanation_df <- do.call(rbind,pheno_gain_explanation) 

# Add overall row
overall_row <- pbmcapply::pbmclapply(pheno_recons,FUN=function(x){
  pheno_recon_pcdf <- parent_child_dfs$blbli_dich_num[[x]]
  pheno_recon_gains <- pheno_recon_pcdf[pheno_recon_pcdf$gain==1,'child'] 
  pheno_recon_gains <- sort(as.numeric(pheno_recon_gains)) 
  num_pheno_gain <- length(pheno_recon_gains)
  geno_recon_pcdfs <- subset(parent_child_dfs,names(parent_child_dfs) != 'blbli_dich_num')
  
  geno_recon_gains <- lapply(geno_recon_pcdfs,FUN=function(y){
    lapply(y,FUN=function(genopcdf){
       genopcdf[genopcdf$gain==1,'child']
    })})
  geno_recon_gains <- sort(unique(unlist(geno_recon_gains))) 
   
    num_nodes_w_geno_gains <- length(geno_recon_gains)
    pheno_gain_nodes_w_geno_gains <- subset(pheno_recon_gains, pheno_recon_gains %in% geno_recon_gains)
    num_pheno_gain_nodes_w_geno_gains <- length(pheno_gain_nodes_w_geno_gains)
    prop_pheno_gains_w_geno_gain <- num_pheno_gain_nodes_w_geno_gains / num_pheno_gain
    perc_pheno_gains_w_geno_gain <- prop_pheno_gains_w_geno_gain*100
    data.frame(genotype = "Overall",pheno_reconstruction = x,pheno_recon_gains = paste0(pheno_recon_gains,collapse = ','),num_pheno_gain,geno_recon_gains = paste0(geno_recon_gains,collapse=','),num_nodes_w_geno_gains,prop_pheno_gains_w_geno_gain,perc_pheno_gains_w_geno_gain)
  },mc.cores = 7) %>% do.call(rbind,.) 

pheno_gain_explanation_df <- rbind(pheno_gain_explanation_df,overall_row)

# Organize
pheno_gain_explanation_df$genotype <- factor_genotypes_boxplot(pheno_gain_explanation_df$genotype)
pheno_gain_explanation_df$genotype <- recode_genotypes(pheno_gain_explanation_df$genotype)
levels(pheno_gain_explanation_df$genotype) <- recode_genotypes_for_html(levels(pheno_gain_explanation_df$genotype))

pheno_gain_explanation_df$pheno_number <- gsub("alt_recon_","",pheno_gain_explanation_df$pheno_reconstruction)
cluster_names <- clustering_str %>% `names<-`(seq_len(length(.)))
pheno_gain_explanation_df$pheno_cluster <-ifelse(grepl("focal", pheno_gain_explanation_df$pheno_number),
                                               pheno_gain_explanation_df$pheno_number, unname(cluster_names[pheno_gain_explanation_df$pheno_number])) 

pheno_gain_explanation_df$pheno_cluster <- recode_phenotype_clusters(pheno_gain_explanation_df$pheno_cluster)
pheno_gain_explanation_df$pheno_cluster <- factor(pheno_gain_explanation_df$pheno_cluster,levels = rev(factor_order))

xmaximum <- (ceiling(max(pheno_gain_explanation_df$prop_pheno_gains_w_geno_gain) * 10) / 10) + .01

C <- ggplot(pheno_gain_explanation_df,
       aes(x = prop_pheno_gains_w_geno_gain,
           y = fct_rev(genotype),
           fill = as.factor(pheno_cluster))) +
geom_boxplot(position = position_dodge(width = 0.8),outlier.size = 0.9) +
labs(x = "Proportion of phenotype gains with >=1 genotype gain",
     y = "",
     fill = "Reconstruction axis") + phylogenetic_reconstruction_scale  + theme_bw() + theme(legend.position = 'bottom',axis.text.x = element_markdown(hjust = 0.5,size=11), axis.text.y = element_markdown()) + xlim(NA,xmaximum)  + scale_x_continuous(
  breaks = seq(0, xmaximum-0.01, by = 0.1),
  limits = c(0, xmaximum)
)

C
```

# Construct merged figure
```{r,merged, fig.width=15.5 ,fig.height=6.5}
library(patchwork)

# Define a single, consistent legend title.
legend_title <- ""

# Apply the same title to all plots and specify a horizontal layout for the legend.
# Patchwork will use this structure when it collects the guides.
A <- A + labs(fill = legend_title) + guides(fill = guide_legend(nrow = 2))
B <- B + labs(fill = legend_title) + guides(fill = guide_legend(nrow = 2))
C <- C + labs(fill = legend_title) + guides(fill = guide_legend(nrow = 2))

# 1. Create a dedicated y-axis plot (this part is now correct).
y_axis_plot <- ggplot(A$data, aes(y = !!A$mapping$y)) +
  theme_void() +
  theme(
    axis.text.y = element_markdown(
      size = 11, # Match font size to your main plot
      hjust = 1, # Right-align the text
      colour = "black"
    ),
    # The right margin on the plot now solely controls the gap
    plot.margin = margin(0, 5, 0, 0) # Units are in 'pt'
  )

# 2. Modify plots A, B, and C to remove their y-axes and legends.
A_main <- A + labs(tag = "A") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        plot.tag = element_text(size = 16))

B_main <- B + labs(tag = "B") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        plot.tag = element_text(size = 16))

C_main <- C + labs(tag = "C") +
  theme(axis.title.y = element_blank(),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        legend.position = "none",
        plot.tag = element_text(size = 16))


# 3. Assemble the final figure with patchwork.
figure <- y_axis_plot + A_main + B_main + C_main +
  plot_layout(
    guides = 'collect', # This will now find one single, standardized legend
    # --- KEY FIX 2: Adjust Relative Widths ---
    # Reduce the first value to shrink the space for the y-axis labels.
    # A value of 0.3 or less is likely what you need. Adjust as necessary.
    widths = c(0.01, 1, 1, 1),
  ) &
  # Position the single, collected legend at the bottom.
  theme(legend.position = 'bottom',legend.title = element_text(size=14),legend.text = element_text(size=12))

figure
```

# Save figure
```{r, save}
ggsave("./figures/empirical/pairwise_reconstruction_synchronous_transition_comparisons_boxplot.png",
      dpi = 900,
      bg = 'white',
      plot = figure,
      width = 15.5,
      height = 6.5)
```
