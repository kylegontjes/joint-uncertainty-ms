---
title: "Figure - Painted states and clustering"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR','ggtree') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Dataset
```{r} 
dat <- readRDS("./data/empirical/dataset/df.RDS")
phy <- read.tree("./data/empirical/tree/tree.treefile") 
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
```

# Transition data
```{r}
best_joint_parent_child <- readRDS("./data/empirical/phyloAMR/representative_blbli_joint_uncertainty_parent_child_dfs.RDS")  
phyloAMR_cluster_df <- readRDS("./data/empirical/phyloAMR/representative_blbli_joint_uncertainty_asr_clustering_df.RDS")
clustering_stats <- readRDS("./data/empirical/phyloAMR/representative_blbli_joint_uncertainty_asr_clustering_statistics.RDS")
dat <- left_join(dat,phyloAMR_cluster_df)
rownames(dat) <- dat$isolate_no
```

# Tracing states on the phylogenetic tree 
```{r,fig.width=12.5,fig.height=10} 
painted_trees <- lapply(best_joint_parent_child,paint_tree_with_states,tr = phy,legend_name = "Edge-based non-susceptibility")
painted_trees_wo_legend <- lapply(painted_trees,function(x){x+theme(legend.position = "none")}) 
 
rownames(dat) <- dat$isolate_no

variables <- names(painted_trees)
painted_trees_w_cluster_calls <- lapply(variables,FUN=function(x){
  p_obj <- painted_trees[[x]] 
  p1 <- gheatmap(p_obj,data=dat  %>% select(blbli_dich_num) %>% `colnames<-`("Resistance") %>% mutate_all(as.factor),width = 0.1,colnames_position = 'top',colnames_angle=90, colnames_offset_y = 0.25, hjust = 0, color = NA) + Resistance_scale
  p1.1 <- p1 + ggnewscale::new_scale_fill()
  p2 <- gheatmap(p1.1,data=dat  %>% select(paste0(x,"_asr_cluster_renamed")) %>% `colnames<-`("Clustering"),width = 0.1,colnames_position = 'top',colnames_angle=90, colnames_offset_y = 0.25, hjust = 0, color = NA,offset=0.000025)  + cluster_scale_v + ylim(NA,540)
  p2
})

legend_fig <- cowplot::get_legend(painted_trees_w_cluster_calls[[which.max(clustering_stats$clusters)]])  %>% cowplot::plot_grid()
  
painted_trees_w_cluster_calls_wo_legends <- lapply(painted_trees_w_cluster_calls,FUN=function(x){x + theme(legend.position='none')
}) 
 
tracing_states_on_tree_wo_legend <- cowplot::plot_grid(plotlist = painted_trees_w_cluster_calls_wo_legends,nrow=2,labels ="AUTO",label_x = 0,label_size = 12)

tracing_states_on_tree <- cowplot::plot_grid(tracing_states_on_tree_wo_legend,legend_fig,ncol=2,rel_widths = c(1,0.2))

tracing_states_on_tree

ggsave("./figures/empirical/ancestral_states_on_phylogeny.png",dpi = 900,bg = 'white',plot = tracing_states_on_tree,width=12.5,height=10)
```