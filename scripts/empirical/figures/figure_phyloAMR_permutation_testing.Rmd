---
title: "phyloAMR permutation testing"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = FALSE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '~/Desktop/gl_mount/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c("tidyverse",'corHMM','phyloAMR') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Source functions
source("./lib/consistent_themes.R")

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Dataset
```{r} 
dat <- readRDS("./data/empirical/dataset/df.RDS")
phy <- read.tree("./data/empirical/tree/tree.treefile") 
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
```

# Transition data
```{r}
permutation_results <- readRDS("./data/empirical/phyloAMR/phenotype_genotype_transition_association_statistics.RDS")
```

```{r}
synchronous_pvalue_results <- lapply(permutation_results$synchronous_permutations,FUN=function(x){
  lapply(x,FUN=function(y){y[['results_df']]}) %>% do.call(rbind.data.frame,.) %>% mutate(comparitor = names(x))
}) 

synchronous_pvalue_results_df <- lapply(names(synchronous_pvalue_results),FUN=function(x){
  synchronous_pvalue_results[[x]] %>% mutate(phenotype_axis = x) 
}) %>% do.call(rbind,.)


downstream_pvalue_results <- lapply(permutation_results$downstream_permutations,FUN=function(x){
  lapply(x,FUN=function(y){y[['results_df']]}) %>% do.call(rbind.data.frame,.) %>% mutate(comparitor = names(x))
}) 

downstream_pvalue_results_df <- lapply(names(downstream_pvalue_results),FUN=function(x){
  downstream_pvalue_results[[x]] %>% mutate(phenotype_axis = x) 
}) %>% do.call(rbind,.)
```
# Synchronous p-values 
```{r,fig.height=15,fig.width=12.5}
axes_fill <- scale_fill_manual(breaks = c(unique(synchronous_pvalue_results_df$phenotype_axis)%>% factor),values=c("black", "#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00", "#FFFF33","gray"),name="Phenotype Axis")

sync_variables <- c("transition_pval","synchronous_gain_pval","synchronous_loss_pval","synchronous_gain_loss_pval","synchronous_gain_loss_pval","synchronous_loss_gain_pval")

synchronous_pval_figs <- lapply(sync_variables,FUN=function(x){
  
ggplot(data=synchronous_pvalue_results_df,aes(x=comparitor,y=-log(get(x)),group=as.factor(phenotype_axis),fill=as.factor(phenotype_axis))) + geom_bar(position="dodge",stat='identity') + axes_fill + theme_bw() + ylab(x) + xlab("Comparitor") + ylim(NA,6.5) + theme(axis.text.x = element_text(angle=90)) + geom_hline(yintercept = -log(0.1),linetype = 2)   + geom_hline(yintercept = -log(0.05),colour = 'red',linetype = 2)
})

synchronous_pvalue_plots <- cowplot::plot_grid(plotlist = synchronous_pval_figs,ncol=2,labels = "AUTO")

synchronous_pvalue_plots

ggsave("./figures/empirical/phyloAMR_synchronous_permutation_test_pvalues.png",dpi = 900,bg = 'white',plot = synchronous_pvalue_plots,width=12.5,height=17.5) 
```

# Downstream p-values 

```{r,fig.height=17.5,fig.width=12.5} 
downstream_variables <-colnames(downstream_pvalue_results_df) %>% subset(!.%in% c('comparitor','phenotype_axis'))

downstream_pval_figs <- lapply(downstream_variables,FUN=function(x){
  
ggplot(data=downstream_pvalue_results_df,aes(x=comparitor,y=-log(get(x)),group=as.factor(phenotype_axis),fill=as.factor(phenotype_axis))) + geom_bar(position="dodge",stat='identity') + axes_fill   + theme_bw() + ylab(x) + xlab("Comparitor") + ylim(NA,6.5) + theme(axis.text.x = element_text(angle=90)) + geom_hline(yintercept = -log(0.1),linetype = 2)   + geom_hline(yintercept = -log(0.05),colour = 'red',linetype = 2)
})

downstream_pvalue_plots <- cowplot::plot_grid(plotlist = downstream_pval_figs,ncol=2,labels = "AUTO")

downstream_pvalue_plots

ggsave("./figures/empirical/phyloAMR_downstream_permutation_test_pvalues.png",dpi = 900,bg = 'white',plot = downstream_pvalue_plots,width=12.5,height=17.5) 
```
