---
title: "Clustering of alternative reconstructions for BL/BLI resistance using tSNE and dbscan"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = TRUE, warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '/nfs/turbo/umms-esnitkin/Project_Penn_KPC/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c('ape','dbscan','Rtsne') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load distance matrix
```{r}
phylo_dist_mat_local <- readRDS("./data/empirical/joint_reconstruction/joint_uncertainty_asr_phylo_dist_matrix.RDS")
phylo_dist_mat_local <- as.matrix(phylo_dist_mat_local) 
```

# Perform tSNE + dbscan clustering
## Methodology:
1. Set seed

2. Perform tSNE on distance matrix

3. Get second derivative 

4. Get elbow (max second derivative) 

5. Multiply by 0.95 to dampen the behavior 

6. Cluster tSNE results using tSNE results, the reduced eps, and minimum points (15 points)

```{r, tsne dbscan clustering}
# Number of reconstructions
nrecon <- nrow(phylo_dist_mat_local)
# Get minimum points 
min_pts <-  min(max(round(.01 * nrecon), 15), 40)

# Helper reduced eps function
compute_eps <- function(tsne_mat, min_pts){
  distances <- kNNdist(tsne_mat, k = min_pts - 1)
  sorted_distances <- sort(distances, decreasing = F)
  second_deriv <- diff(sorted_distances, differences = 2)
  elbow_id <- which.max(second_deriv) + 1L
  sorted_distances[elbow_id]   * 0.95 
}

# Clustering methodology
dbscan_clustering <- function(phylo_dist_mat_local, seed, min_pts){
  # Set seed
  set.seed(seed)
  # Run tSNE
  tsne_res <- Rtsne(phylo_dist_mat_local, is_distance = T, verbose = F, check_duplicates = FALSE) 
  # Get second derivative to identify eps
  reduced_eps <- compute_eps(tsne_mat = tsne_res$Y, min_pts = min_pts) 
  # Run dbscan
  dbres <- dbscan(tsne_res$Y, eps = reduced_eps, minPts = min_pts) 
  return(dbres)
}

# Apply on seeds 1 to 1000
## Break up into chunks to improve memory usage
seeds <- 1:1000
chunk_size <- 10
seed_chunks <- split(seeds, ceiling(seq_along(seeds)/chunk_size))

## Run on seed chunks
ncores <-  35
results <- pbmcapply::pbmclapply(
  seed_chunks,
  mc.cores = ncores,
  FUN = function(chunk){
    lapply(chunk, function(s){
      dbscan_clustering(phylo_dist_mat_local, seed = s, min_pts = min_pts)
    })
  }
)

## Flatten to single list
results <- do.call(c, results) 

# Save tSNE + dbscan clustering results
saveRDS(results,"./data/empirical/joint_reconstruction/joint_uncertainty_dbscan_multiple_seeds_clustering.RDS")
```

# Generate consensus matrix
```{r consensus distance}
# Create raw matrix
consensus_matrix <- matrix(0, nrecon, nrecon)

# Generate consensus matrix
## This represents the number of times a sample clusters with other samples
### Larger values = strong and stable co-association
### Smaller values = rare co-association 
for (cl in results) {
  # Get cluster assignments
  z <- cl$cluster
  # Get indices for samples assigned to a cluster (i.e., 0 = noise point)
  idx <- which(z != 0)
  # Group sample indices by their cluster label
  for (k in split(idx, z[idx])) {
    # For samples in same cluster, add value 1
    consensus_matrix[k, k] <- consensus_matrix[k, k] + 1
  }
}

# Normalize this matrix by the number of clustering attempts
consensus_matrix <- consensus_matrix / length(results) 
## Save normalized consensus matrix
saveRDS(consensus_matrix,"./data/empirical/joint_reconstruction/joint_uncertainty_dbscan_multiple_seeds_consensus_matrix.RDS")

# Convert to a distance (i.e., 1 - consensus) for use with re-clustering
consensus_dist <- as.dist(1 - consensus_matrix)
## Save consensus distance matrix
saveRDS(consensus_dist,"./data/empirical/joint_reconstruction/joint_uncertainty_dbscan_multiple_seeds_consensus_distance_matrix.RDS")
```