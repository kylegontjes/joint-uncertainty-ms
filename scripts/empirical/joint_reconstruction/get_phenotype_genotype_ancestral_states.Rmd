---
title: "Get ancestral state reconstructions for BL/BLI resistance and related genotypes"
author: "Kyle Gontjes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
require(knitr) 
opts_knit$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
opts_chunk$set(echo = TRUE,warning = FALSE, message = FALSE,error=FALSE,comment=NA) 
knitr::opts_knit$set(root.dir = '/nfs/turbo/umms-esnitkin/Project_Penn_KPC/Analysis/Phyloaware/joint-uncertainty-ms/') 
```

```{r environment, echo=T, message=FALSE, include=T, results=T}
#Packages
packages <- c('corHMM','dplyr','ape') 

#Load Packages
invisible(lapply(packages,library,character.only=T,quietly=T))

# Print environment
set.seed(0104) 
Sys.info()
sessionInfo()
```

# Load data
## Phylogeny and dataset
```{r, phylo df data}  
phy <- ape::read.tree("./data/empirical/tree/tree.treefile")
dat <- readRDS("./data/empirical/dataset/df.RDS")
dat <- dat[match(phy$tip.label, dat[['isolate_no']]), ]
```

## Genotypes
```{r, genotype load}
genotypes <- readRDS("./data/empirical/resistance_genotypes/resistance_genotypes.RDS") 
genotypes <-  genotypes[match(phy$tip.label,genotypes[['isolate_no']]),]
rownames(genotypes) <- genotypes$isolate_no

df <- dplyr::left_join(dat,genotypes)
rownames(df) <- df$isolate_no
```

# Generate ancestral state reconstruction data for BL/BLI resistance and genotypes
```{r, focal reconstructions}
genotype_names <- subset(colnames(genotypes),colnames(genotypes) !="isolate_no")

traits <- c("blbli_dich_num",genotype_names)

focal_asrs <- pbmcapply::pbmclapply(traits, FUN=function(x,dat,phy){
  cor_dat <- data.frame(sp = dat$isolate_no, d = dat[[x]], row.names = dat$isolate_no) 
  cor_dat <- cor_dat[match(phy$tip.label, cor_dat[['sp']]), ]
  focal <- corHMM(phy = phy, data =  cor_dat, rate.cat = 1, model = "ER", node.states = "joint", upper.bound = 1e100, lower.bound = 1e-9, root.p = "maddfitz")
},dat=df, phy=phy, mc.cores=15)  

names(focal_asrs) <- traits

saveRDS(focal_asrs,"./data/empirical/joint_reconstruction/phenotype_genotype_focal_asrs.RDS")
```

# Generate alternative reconstructions 
```{r, alt recons} 
joint_asrs <- pbmcapply::pbmclapply(focal_asrs,FUN=function(focal){  
    joint_ci_individual <- corHMM:::compute_joint_ci(
      focal, 
      batch_size = 100,   
      max_samples = 10000, 
      p_method = "simmap") 
}, mc.cores=15)  

names(joint_asrs) <- names(focal_asrs)

saveRDS(joint_asrs,"./data/empirical/joint_reconstruction/phenotype_genotype_joint_uncertainty_asrs.RDS")
```

# Determine whether the focal output's ancestral states match the uncertainty reconstruction's best joint state
## Observation: We've noticed that ancestral state reconstructions for two traits (BL/BLI resistance and L3 insertion in ompK36) sometimes differ across runs due to the stochastic nature of the method.
### Decision: Prioritize use of the best reconstruction from the joint uncertainty output. 
#### Re-run condition: Only if BL/BLI resistance (phenotype) focal and joint states do not match
```{r, matching states check}
matching <- lapply(names(focal_asrs),FUN=function(name){ 
  table(focal_asrs[[name]]$states == joint_asrs[[name]]$best_joint$lik.anc.states)})

names(matching) <- names(focal_asrs)

matching
```

# Number of reconstructions 
```{r, number of reconstructions}
joint_unc_stats <- function(name,joint_asrs){
  trait = name
  n_reconstructions = length(joint_asrs[[name]]$lnliks)
  return(data.frame(trait = name, n_reconstructions = n_reconstructions))
}

reconstruction_count <- lapply(names(joint_asrs), joint_unc_stats, joint_asrs)
reconstruction_count_df <- do.call(rbind,reconstruction_count) 
reconstruction_count_df
```